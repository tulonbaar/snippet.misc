name: Sync Branches

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to sync from (default: main)'
        required: false
        default: 'main'
      target_branches:
        description: 'Branches to sync (comma-separated, default: prod,dev,test)'
        required: false
        default: 'prod,dev,test'

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Set target branches
      id: set-branches
      run: |
        SOURCE="${{ github.event.inputs.source_branch }}"
        BRANCHES="${{ github.event.inputs.target_branches }}"
        echo "source=$SOURCE" >> $GITHUB_OUTPUT
        echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
        echo "Source branch: $SOURCE"
        echo "Target branches: $BRANCHES"
    
    - name: Sync branches
      run: |
        SOURCE="${{ steps.set-branches.outputs.source }}"
        BRANCHES="${{ steps.set-branches.outputs.branches }}"
        IFS=',' read -ra BRANCH_ARRAY <<< "$BRANCHES"
        
        for branch in "${BRANCH_ARRAY[@]}"; do
          branch=$(echo "$branch" | xargs) # trim whitespace
          echo "Syncing branch: $branch from $SOURCE"
          
          # Check if branch exists
          if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
            echo "Branch $branch exists, proceeding with sync..."
            
            # Checkout the target branch
            if ! git checkout -B "$branch" "origin/$branch"; then
              echo "Failed to check out branch $branch from origin/$branch"
              exit 1
            fi
            
            # Merge source into the target branch
            if git merge "origin/$SOURCE" --no-edit; then
              echo "Successfully merged $SOURCE into $branch"
              
              # Push the updated branch
              if git push origin "$branch"; then
                echo "Successfully pushed $branch"
              else
                echo "Failed to push $branch"
                exit 1
              fi
            else
              echo "Merge conflict detected in $branch"
              echo "Please resolve conflicts manually for branch: $branch"
              
              # Create an issue to notify about merge conflict
              gh issue create \
                --title "Merge conflict: Failed to sync $branch with $SOURCE" \
                --body "Automatic synchronization of branch \`$branch\` with \`$SOURCE\` failed due to merge conflicts. Please resolve the conflicts manually and merge the changes." \
                --label "merge-conflict,automation" || echo "Failed to create issue"
              
              # Abort the merge and fail the workflow
              git merge --abort
              exit 1
            fi
          else
            echo "Branch $branch does not exist, creating from $SOURCE..."
            git checkout -b "$branch" "origin/$SOURCE"
            git push origin "$branch"
            echo "Created and pushed new branch: $branch"
          fi
          
          echo "---"
        done
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    - name: Summary
      run: |
        echo "Branch synchronization completed!"
        echo "Source branch: ${{ steps.set-branches.outputs.source }}"
        echo "Synchronized branches: ${{ steps.set-branches.outputs.branches }}"